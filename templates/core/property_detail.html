{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}{{ property.title }}{% endblock %}

{% block content %}

<div class="bg-light py-4 mb-5">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'properties_list' %}">Properties</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ property.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container mb-5">
    <div class="row g-5">
        
        <div class="col-lg-8">
            <div class="position-relative mb-4">
                {% if property.main_image %}
                    <img src="{{ property.main_image.url }}" class="img-fluid rounded shadow w-100" style="max-height: 500px; object-fit: cover;" alt="{{ property.title }}">
                {% else %}
                    <div class="bg-secondary text-white rounded d-flex align-items-center justify-content-center" style="height: 400px;">No Image</div>
                {% endif %}
                
                <span class="badge position-absolute top-0 start-0 m-3 py-2 px-3 fs-6 shadow
                    {% if property.status == 'sold' %}bg-danger
                    {% elif property.status == 'for_rent' %}bg-info
                    {% else %}bg-success{% endif %}">
                    {{ property.get_status_display }}
                </span>
            </div>

            <h2 class="fw-bold mb-3">{{ property.title }}</h2>
            <h4 class="text-accent fw-bold mb-4">${{ property.price|intcomma }}</h4>
            
            <div class="d-flex align-items-center text-muted mb-4">
                <i class="fas fa-map-marker-alt me-2 text-primary"></i> {{ property.location }}
                <span class="mx-3">|</span>
                <i class="fas fa-tag me-2 text-primary"></i> {{ property.get_category_display }}
            </div>
            
            <hr>
            
            <h5 class="fw-bold mt-4">Property Description</h5>
            <p class="text-muted" style="white-space: pre-line;">{{ property.description }}</p>

            <div class="card bg-light border-0 p-4 mt-5">
                <h4 class="fw-bold mb-3"><i class="fas fa-calculator me-2 text-primary"></i>Mortgage Calculator</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="small fw-bold">Price ($)</label>
                        <input type="number" id="calc-price" class="form-control" value="{{ property.price }}">
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold">Down Payment ($)</label>
                        <input type="number" id="calc-down" class="form-control" value="10000">
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold">Interest Rate (%)</label>
                        <input type="number" id="calc-rate" class="form-control" value="6.5">
                    </div>
                    <div class="col-md-6">
                        <label class="small fw-bold">Years</label>
                        <select id="calc-years" class="form-select">
                            <option value="30">30 Years</option>
                            <option value="15">15 Years</option>
                        </select>
                    </div>
                    <div class="col-12 mt-3 text-center">
                        <h5 class="fw-bold">Monthly Payment: <span class="text-accent" id="calc-result">$0.00</span></h5>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="calculateMortgage()">Calculate</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 100px;">
                <div class="card-body p-4">
                    <h4 class="fw-bold mb-3">Interested?</h4>
                    <p class="text-muted small">Contact us to schedule a viewing for this property.</p>
                    
                    <form action="{% url 'contact' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="subject" value="Inquiry about {{ property.title }}">
                        <div class="mb-3">
                            <input type="text" name="name" class="form-control bg-light" placeholder="Your Name" required>
                        </div>
                        <div class="mb-3">
                            <input type="email" name="email" class="form-control bg-light" placeholder="Your Email" required>
                        </div>
                        <div class="mb-3">
                            <textarea name="message" class="form-control bg-light" rows="3" placeholder="I'm interested in this property..." required>I am interested in {{ property.title }} located at {{ property.location }}.</textarea>
                        </div>
                        <button type="submit" class="btn btn-accent w-100 fw-bold">Send Message</button>
                    </form>
                    
                    <hr class="my-4">
                    <div class="d-flex align-items-center justify-content-center">
                        <a href="tel:+233205843775" class="btn btn-outline-dark rounded-pill px-4">
                            <i class="fas fa-phone-alt me-2"></i> Call Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function calculateMortgage() {
    let price = parseFloat(document.getElementById('calc-price').value) || 0;
    let down = parseFloat(document.getElementById('calc-down').value) || 0;
    let rate = parseFloat(document.getElementById('calc-rate').value) || 0;
    let years = parseFloat(document.getElementById('calc-years').value) || 30;

    let principal = price - down;
    let monthlyRate = rate / 100 / 12;
    let payments = years * 12;

    if(principal > 0 && rate > 0) {
        let x = Math.pow(1 + monthlyRate, payments);
        let monthly = (principal * x * monthlyRate) / (x - 1);
        document.getElementById('calc-result').innerText = "$" + monthly.toFixed(2);
    }
}
</script>

{% endblock %}